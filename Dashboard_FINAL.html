<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inteligencia Institucional - Diagnóstico Académico</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette */
            --color-bg-main: #F6F8FA;
            --color-surface: #FFFFFF;

            --color-primary-700: #1E3A8A;
            --color-primary-600: #1D4ED8;
            --color-primary-500: #2563EB;

            --text-primary: #0F172A;
            --text-secondary: #475569;
            --border-subtle: #E2E8F0;

            /* Semantic (Desaturated/Opacity handled in usage or here) */
            --color-success: #059669;
            --color-warning: #D97706;
            --color-critical: #DC2626;

            /* Spacing */
            --space-1: 8px;
            --space-2: 16px;
            --space-3: 24px;
            --space-4: 32px;
            --space-5: 48px;

            /* Components */
            --radius-lg: 16px;
            --shadow-soft: 0px 1px 2px rgba(15, 23, 42, 0.04), 0px 4px 12px rgba(15, 23, 42, 0.06);
            --shadow-hover: 0px 6px 20px rgba(15, 23, 42, 0.08);
            --ease-standard: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--color-bg-main);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding: 0;
        }

        .dashboard-container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 40px;
        }

        /* Header */
        .header {
            margin-bottom: var(--space-5);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid rgba(15,23,42,0.06);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--color-primary-700);
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: var(--space-5);
        }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            padding: 24px;
            transition: all 240ms var(--ease-standard);
            border: 1px solid transparent;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* Metric Card Specifics */
        .metric-card {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 140px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.03em;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            margin-top: auto;
        }

        .metric-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 4px;
        }

        .metric-icon {
            position: absolute;
            top: 24px;
            right: 24px;
            color: var(--text-secondary);
            opacity: 0.5;
        }

        /* Filters */
        .filters-section {
            margin-bottom: var(--space-4);
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 4px; /* for scrollbar */
            scrollbar-width: none; /* Firefox */
        }
        .filters-section::-webkit-scrollbar { display: none; }

        .segmented-control {
            display: inline-flex;
            gap: 8px;
            background: rgba(15, 23, 42, 0.03); /* Subtle track */
            padding: 4px;
            border-radius: 99px;
        }

        .filter-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 99px;
            cursor: pointer;
            transition: background-color 200ms ease, color 200ms ease;
            font-family: inherit;
        }

        .filter-btn:hover {
            background-color: rgba(255,255,255, 0.5);
            color: var(--color-primary-700);
        }

        .filter-btn.active {
            background-color: var(--color-primary-600);
            color: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 600;
        }

        /* Chart Area */
        .chart-card {
            background: var(--color-surface);
            border-radius: 20px;
            padding: 32px;
            box-shadow: var(--shadow-soft);
            background: linear-gradient(to bottom, #FFFFFF 0%, rgba(255,255,255,0.6) 100%);
            border: 1px solid rgba(15,23,42,0.06);
        }

        .chart-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 24px;
        }

        /* Legend */
        .legend-items {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.2s;
        }

        .legend-item:hover {
            opacity: 0.8;
        }

        .legend-item.disabled {
            opacity: 0.3;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .legend-text {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .export-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 12px 24px;
            background: var(--color-primary-700);
            color: white;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            z-index: 1000;
            border-radius: 8px;
        }

        .export-btn:hover {
            background: var(--color-primary-600);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }
    </style>

</head>

<body>
    <main class="dashboard-container">
        <header class="header">
            <h1>Diagnóstico de Salud Digital</h1>
            <p>Inteligencia Institucional • Análisis de Comentarios</p>
        </header>

        <section class="kpi-grid">
            <div class="card metric-card">
                <div class="metric-label">Materias Evaluadas</div>
                <div class="metric-value" data-target="37">0</div>
                <div class="metric-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                </div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Total Comentarios</div>
                <div class="metric-value" data-target="5723">0</div>
                 <div class="metric-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                </div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Alertas Críticas</div>
                <div class="metric-value" style="color: var(--color-critical);" data-target="1467">0</div>
                 <div class="metric-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                </div>
            </div>
            <div class="card metric-card">
                <div class="metric-label">Tasa de Fricción</div>
                <div class="metric-value" style="color: var(--color-critical);" data-target="25.6" data-suffix="%">0%</div>
                 <div class="metric-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                </div>
            </div>
        </section>

        <section class="filters-section">
            <div class="segmented-control" id="filterButtons">
                <!-- Buttons injected by JS -->
            </div>
        </section>

        <section class="chart-card">
            <div class="chart-header">
                <div class="legend-items">
                    <div class="legend-item" onclick="toggleSeries('success')">
                        <div class="legend-dot" style="background: var(--color-success);"></div>
                        <div class="legend-text">Zona Óptima (&lt;15%)</div>
                    </div>
                    <div class="legend-item" onclick="toggleSeries('warning')">
                        <div class="legend-dot" style="background: var(--color-warning);"></div>
                        <div class="legend-text">Alerta (15-30%)</div>
                    </div>
                    <div class="legend-item" onclick="toggleSeries('critical')">
                        <div class="legend-dot" style="background: var(--color-critical);"></div>
                        <div class="legend-text">Crítico (&gt;30%)</div>
                    </div>
                     <div class="legend-item" style="cursor: default;">
                        <div class="legend-dot" style="background: var(--text-secondary); width: 6px; height: 6px;"></div>
                        <div class="legend-text">Volumen = Tamaño</div>
                    </div>
                </div>
            </div>
            <div id="plot"></div>
        </section>
    </main>

    <button class="export-btn" onclick="exportToPNG()">Exportar Informe</button>

    <script>
        // Datos embebidos
        const allData = [{"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "ADMINISTRACIÓN ESTRATÉGICA", "promedio_cae": 4.723333333333334, "total_comentarios": 242, "comentarios_negativos": 32, "comentarios_positivos": 145, "comentarios_neutros": 65.0, "dolor_docente": 6.0, "dolor_actividades": 10.0, "dolor_contenido": 5.0, "dolor_plataforma": 2.0, "dolor_modalidad": 6.0, "dolor_equipo": 1.0, "dolor_otros": 2.0, "pct_negativos": 13.22, "pct_dolor_docente": 18.8, "pct_dolor_actividades": 31.2, "pct_dolor_contenido": 15.6, "pct_dolor_plataforma": 6.2, "pct_dolor_modalidad": 18.8, "pct_dolor_equipo": 3.1, "pct_dolor_otros": 6.2, "pct_positivos": 59.9, "pct_neutros": 26.9, "color": "#10b981"}, {"departamento": "919 - DEPARTAMENTO DE INGENIERÍAS", "materia": "BIOÉTICA", "promedio_cae": 4.505, "total_comentarios": 58, "comentarios_negativos": 22, "comentarios_positivos": 28, "comentarios_neutros": 8.0, "dolor_docente": 5.0, "dolor_actividades": 1.0, "dolor_contenido": 2.0, "dolor_plataforma": 3.0, "dolor_modalidad": 5.0, "dolor_equipo": 6.0, "dolor_otros": 0, "pct_negativos": 37.93, "pct_dolor_docente": 22.7, "pct_dolor_actividades": 4.5, "pct_dolor_contenido": 9.1, "pct_dolor_plataforma": 13.6, "pct_dolor_modalidad": 22.7, "pct_dolor_equipo": 27.3, "pct_dolor_otros": 0.0, "pct_positivos": 48.3, "pct_neutros": 13.8, "color": "#ef4444"}, {"departamento": "905 - DEPARTAMENTO DE CIENCIAS SOCIALES Y HUMANIDADES", "materia": "COMUNICACIÓN POLÍTICA Y LEGISLACIÓN DE MEDIOS", "promedio_cae": 4.285, "total_comentarios": 32, "comentarios_negativos": 14, "comentarios_positivos": 9, "comentarios_neutros": 9.0, "dolor_docente": 1.0, "dolor_actividades": 2.0, "dolor_contenido": 5.0, "dolor_plataforma": 0, "dolor_modalidad": 5.0, "dolor_equipo": 0, "dolor_otros": 1.0, "pct_negativos": 43.75, "pct_dolor_docente": 7.1, "pct_dolor_actividades": 14.3, "pct_dolor_contenido": 35.7, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 35.7, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 7.1, "pct_positivos": 28.1, "pct_neutros": 28.1, "color": "#ef4444"}, {"departamento": "925 - COORDINACIÓN DE EMPRENDIMIENTO UNIVERSITARIO", "materia": "CREACIÓN DE NEGOCIOS", "promedio_cae": 4.580666666666667, "total_comentarios": 346, "comentarios_negativos": 73, "comentarios_positivos": 177, "comentarios_neutros": 96.0, "dolor_docente": 31.0, "dolor_actividades": 14.0, "dolor_contenido": 11.0, "dolor_plataforma": 0, "dolor_modalidad": 2.0, "dolor_equipo": 9.0, "dolor_otros": 6.0, "pct_negativos": 21.1, "pct_dolor_docente": 42.5, "pct_dolor_actividades": 19.2, "pct_dolor_contenido": 15.1, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 2.7, "pct_dolor_equipo": 12.3, "pct_dolor_otros": 8.2, "pct_positivos": 51.2, "pct_neutros": 27.7, "color": "#f59e0b"}, {"departamento": "1 - DEPARTAMENTO DE ARQUITECTURA Y DISEÑO", "materia": "CRÍTICA DEL ARTE Y CULTURA", "promedio_cae": 4.95, "total_comentarios": 56, "comentarios_negativos": 10, "comentarios_positivos": 35, "comentarios_neutros": 11.0, "dolor_docente": 0, "dolor_actividades": 4.0, "dolor_contenido": 0, "dolor_plataforma": 0, "dolor_modalidad": 5.0, "dolor_equipo": 1.0, "dolor_otros": 0, "pct_negativos": 17.86, "pct_dolor_docente": 0.0, "pct_dolor_actividades": 40.0, "pct_dolor_contenido": 0.0, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 50.0, "pct_dolor_equipo": 10.0, "pct_dolor_otros": 0.0, "pct_positivos": 62.5, "pct_neutros": 19.6, "color": "#f59e0b"}, {"departamento": "4 - CIENCIAS JURÍDICAS", "materia": "DERECHO DE LOS NEGOCIOS", "promedio_cae": 4.4, "total_comentarios": 4, "comentarios_negativos": 1, "comentarios_positivos": 3, "comentarios_neutros": 0, "dolor_docente": 0, "dolor_actividades": 1.0, "dolor_contenido": 0, "dolor_plataforma": 0, "dolor_modalidad": 0, "dolor_equipo": 0, "dolor_otros": 0, "pct_negativos": 25.0, "pct_dolor_docente": 0.0, "pct_dolor_actividades": 100.0, "pct_dolor_contenido": 0.0, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 0.0, "pct_positivos": 75.0, "pct_neutros": 0, "color": "#f59e0b"}, {"departamento": "905 - DEPARTAMENTO DE CIENCIAS SOCIALES Y HUMANIDADES", "materia": "DERECHO INTERNACIONAL PRIVADO", "promedio_cae": 4.2, "total_comentarios": 180, "comentarios_negativos": 70, "comentarios_positivos": 68, "comentarios_neutros": 42.0, "dolor_docente": 17.0, "dolor_actividades": 11.0, "dolor_contenido": 12.0, "dolor_plataforma": 11.0, "dolor_modalidad": 18.0, "dolor_equipo": 0, "dolor_otros": 1.0, "pct_negativos": 38.89, "pct_dolor_docente": 24.3, "pct_dolor_actividades": 15.7, "pct_dolor_contenido": 17.1, "pct_dolor_plataforma": 15.7, "pct_dolor_modalidad": 25.7, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 1.4, "pct_positivos": 37.8, "pct_neutros": 23.3, "color": "#ef4444"}, {"departamento": "912 - CENTRO DE FORMACIÓN HUMANISTA", "materia": "DESAFÍOS ÉTICOS DE LA CIENCIA Y LA TECNOLOGÍA", "promedio_cae": 4.776250000000001, "total_comentarios": 298, "comentarios_negativos": 48, "comentarios_positivos": 173, "comentarios_neutros": 77.0, "dolor_docente": 13.0, "dolor_actividades": 20.0, "dolor_contenido": 8.0, "dolor_plataforma": 2.0, "dolor_modalidad": 2.0, "dolor_equipo": 0, "dolor_otros": 3.0, "pct_negativos": 16.11, "pct_dolor_docente": 27.1, "pct_dolor_actividades": 41.7, "pct_dolor_contenido": 16.7, "pct_dolor_plataforma": 4.2, "pct_dolor_modalidad": 4.2, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 6.2, "pct_positivos": 58.1, "pct_neutros": 25.8, "color": "#f59e0b"}, {"departamento": "1 - DEPARTAMENTO DE ARQUITECTURA Y DISEÑO", "materia": "DISEÑO DE CONTENIDOS DIGITALES", "promedio_cae": 4.215, "total_comentarios": 40, "comentarios_negativos": 13, "comentarios_positivos": 17, "comentarios_neutros": 10.0, "dolor_docente": 1.0, "dolor_actividades": 3.0, "dolor_contenido": 1.0, "dolor_plataforma": 0, "dolor_modalidad": 8.0, "dolor_equipo": 0, "dolor_otros": 0, "pct_negativos": 32.5, "pct_dolor_docente": 7.7, "pct_dolor_actividades": 23.1, "pct_dolor_contenido": 7.7, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 61.5, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 0.0, "pct_positivos": 42.5, "pct_neutros": 25.0, "color": "#ef4444"}, {"departamento": "1 - DEPARTAMENTO DE ARQUITECTURA Y DISEÑO", "materia": "DISEÑO DE JUEGOS", "promedio_cae": 4.6, "total_comentarios": 124, "comentarios_negativos": 51, "comentarios_positivos": 45, "comentarios_neutros": 28.0, "dolor_docente": 8.0, "dolor_actividades": 3.0, "dolor_contenido": 7.0, "dolor_plataforma": 4.0, "dolor_modalidad": 29.0, "dolor_equipo": 0, "dolor_otros": 0, "pct_negativos": 41.13, "pct_dolor_docente": 15.7, "pct_dolor_actividades": 5.9, "pct_dolor_contenido": 13.7, "pct_dolor_plataforma": 7.8, "pct_dolor_modalidad": 56.9, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 0.0, "pct_positivos": 36.3, "pct_neutros": 22.6, "color": "#ef4444"}, {"departamento": "918 - DEPARTAMENTO DE CIENCIAS DE LA SALUD", "materia": "DISEÑO DE PROYECTOS DE INTERVENCIÓN", "promedio_cae": 4.3999999999999995, "total_comentarios": 82, "comentarios_negativos": 38, "comentarios_positivos": 31, "comentarios_neutros": 13.0, "dolor_docente": 6.0, "dolor_actividades": 11.0, "dolor_contenido": 2.0, "dolor_plataforma": 3.0, "dolor_modalidad": 14.0, "dolor_equipo": 0, "dolor_otros": 2.0, "pct_negativos": 46.34, "pct_dolor_docente": 15.8, "pct_dolor_actividades": 28.9, "pct_dolor_contenido": 5.3, "pct_dolor_plataforma": 7.9, "pct_dolor_modalidad": 36.8, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 5.3, "pct_positivos": 37.8, "pct_neutros": 15.9, "color": "#ef4444"}, {"departamento": "918 - DEPARTAMENTO DE CIENCIAS DE LA SALUD", "materia": "ÉTICA PROFESIONAL DE LA PSICOLOGÍA", "promedio_cae": 4.63, "total_comentarios": 144, "comentarios_negativos": 53, "comentarios_positivos": 49, "comentarios_neutros": 42.0, "dolor_docente": 5.0, "dolor_actividades": 14.0, "dolor_contenido": 3.0, "dolor_plataforma": 1.0, "dolor_modalidad": 28.0, "dolor_equipo": 1.0, "dolor_otros": 1.0, "pct_negativos": 36.81, "pct_dolor_docente": 9.4, "pct_dolor_actividades": 26.4, "pct_dolor_contenido": 5.7, "pct_dolor_plataforma": 1.9, "pct_dolor_modalidad": 52.8, "pct_dolor_equipo": 1.9, "pct_dolor_otros": 1.9, "pct_positivos": 34.0, "pct_neutros": 29.2, "color": "#ef4444"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "FINANZAS INTERNACIONALES", "promedio_cae": 4.404999999999999, "total_comentarios": 124, "comentarios_negativos": 23, "comentarios_positivos": 75, "comentarios_neutros": 26.0, "dolor_docente": 6.0, "dolor_actividades": 3.0, "dolor_contenido": 4.0, "dolor_plataforma": 1.0, "dolor_modalidad": 9.0, "dolor_equipo": 0, "dolor_otros": 0, "pct_negativos": 18.55, "pct_dolor_docente": 26.1, "pct_dolor_actividades": 13.0, "pct_dolor_contenido": 17.4, "pct_dolor_plataforma": 4.3, "pct_dolor_modalidad": 39.1, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 0.0, "pct_positivos": 60.5, "pct_neutros": 21.0, "color": "#f59e0b"}, {"departamento": "1 - DEPARTAMENTO DE ARQUITECTURA Y DISEÑO", "materia": "FUNDAMENTOS DE URBANISMO", "promedio_cae": 4.755, "total_comentarios": 68, "comentarios_negativos": 17, "comentarios_positivos": 41, "comentarios_neutros": 10.0, "dolor_docente": 1.0, "dolor_actividades": 5.0, "dolor_contenido": 4.0, "dolor_plataforma": 0, "dolor_modalidad": 5.0, "dolor_equipo": 1.0, "dolor_otros": 1.0, "pct_negativos": 25.0, "pct_dolor_docente": 5.9, "pct_dolor_actividades": 29.4, "pct_dolor_contenido": 23.5, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 29.4, "pct_dolor_equipo": 5.9, "pct_dolor_otros": 5.9, "pct_positivos": 60.3, "pct_neutros": 14.7, "color": "#f59e0b"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "GESTIÓN DE PROYECTOS", "promedio_cae": 4.301, "total_comentarios": 318, "comentarios_negativos": 96, "comentarios_positivos": 138, "comentarios_neutros": 84.0, "dolor_docente": 29.0, "dolor_actividades": 21.0, "dolor_contenido": 8.0, "dolor_plataforma": 4.0, "dolor_modalidad": 14.0, "dolor_equipo": 6.0, "dolor_otros": 14.0, "pct_negativos": 30.19, "pct_dolor_docente": 30.2, "pct_dolor_actividades": 21.9, "pct_dolor_contenido": 8.3, "pct_dolor_plataforma": 4.2, "pct_dolor_modalidad": 14.6, "pct_dolor_equipo": 6.2, "pct_dolor_otros": 14.6, "pct_positivos": 43.4, "pct_neutros": 26.4, "color": "#ef4444"}, {"departamento": "919 - DEPARTAMENTO DE INGENIERÍAS", "materia": "GESTIÓN DE PROYECTOS DE INGENIERÍA", "promedio_cae": 4.644444444444445, "total_comentarios": 190, "comentarios_negativos": 54, "comentarios_positivos": 97, "comentarios_neutros": 39.0, "dolor_docente": 21.0, "dolor_actividades": 11.0, "dolor_contenido": 8.0, "dolor_plataforma": 3.0, "dolor_modalidad": 7.0, "dolor_equipo": 2.0, "dolor_otros": 2.0, "pct_negativos": 28.42, "pct_dolor_docente": 38.9, "pct_dolor_actividades": 20.4, "pct_dolor_contenido": 14.8, "pct_dolor_plataforma": 5.6, "pct_dolor_modalidad": 13.0, "pct_dolor_equipo": 3.7, "pct_dolor_otros": 3.7, "pct_positivos": 51.1, "pct_neutros": 20.5, "color": "#f59e0b"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "HABILIDADES DIRECTIVAS", "promedio_cae": 4.59, "total_comentarios": 18, "comentarios_negativos": 7, "comentarios_positivos": 6, "comentarios_neutros": 5.0, "dolor_docente": 1.0, "dolor_actividades": 3.0, "dolor_contenido": 0, "dolor_plataforma": 0, "dolor_modalidad": 0, "dolor_equipo": 3.0, "dolor_otros": 0, "pct_negativos": 38.89, "pct_dolor_docente": 14.3, "pct_dolor_actividades": 42.9, "pct_dolor_contenido": 0.0, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 42.9, "pct_dolor_otros": 0.0, "pct_positivos": 33.3, "pct_neutros": 27.8, "color": "#ef4444"}, {"departamento": "1 - DEPARTAMENTO DE ARQUITECTURA Y DISEÑO", "materia": "IMAGEN Y CULTURA", "promedio_cae": 4.92, "total_comentarios": 20, "comentarios_negativos": 5, "comentarios_positivos": 12, "comentarios_neutros": 3.0, "dolor_docente": 0, "dolor_actividades": 0, "dolor_contenido": 1.0, "dolor_plataforma": 2.0, "dolor_modalidad": 0, "dolor_equipo": 2.0, "dolor_otros": 0, "pct_negativos": 25.0, "pct_dolor_docente": 0.0, "pct_dolor_actividades": 0.0, "pct_dolor_contenido": 20.0, "pct_dolor_plataforma": 40.0, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 40.0, "pct_dolor_otros": 0.0, "pct_positivos": 60.0, "pct_neutros": 15.0, "color": "#f59e0b"}, {"departamento": "912 - CENTRO DE FORMACIÓN HUMANISTA", "materia": "LIBERTAD DESDE LA PERSPECTIVA CRISTIANA", "promedio_cae": 4.75875, "total_comentarios": 318, "comentarios_negativos": 40, "comentarios_positivos": 200, "comentarios_neutros": 78.0, "dolor_docente": 12.0, "dolor_actividades": 14.0, "dolor_contenido": 4.0, "dolor_plataforma": 3.0, "dolor_modalidad": 0, "dolor_equipo": 1.0, "dolor_otros": 6.0, "pct_negativos": 12.58, "pct_dolor_docente": 30.0, "pct_dolor_actividades": 35.0, "pct_dolor_contenido": 10.0, "pct_dolor_plataforma": 7.5, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 2.5, "pct_dolor_otros": 15.0, "pct_positivos": 62.9, "pct_neutros": 24.5, "color": "#10b981"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "MARKETING DIGITAL", "promedio_cae": 4.3566666666666665, "total_comentarios": 88, "comentarios_negativos": 35, "comentarios_positivos": 27, "comentarios_neutros": 26.0, "dolor_docente": 6.0, "dolor_actividades": 4.0, "dolor_contenido": 3.0, "dolor_plataforma": 0, "dolor_modalidad": 13.0, "dolor_equipo": 7.0, "dolor_otros": 2.0, "pct_negativos": 39.77, "pct_dolor_docente": 17.1, "pct_dolor_actividades": 11.4, "pct_dolor_contenido": 8.6, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 37.1, "pct_dolor_equipo": 20.0, "pct_dolor_otros": 5.7, "pct_positivos": 30.7, "pct_neutros": 29.5, "color": "#ef4444"}, {"departamento": "912 - CENTRO DE FORMACIÓN HUMANISTA", "materia": "PERSPECTIVA DE GÉNERO", "promedio_cae": 4.6075, "total_comentarios": 280, "comentarios_negativos": 72, "comentarios_positivos": 144, "comentarios_neutros": 64.0, "dolor_docente": 12.0, "dolor_actividades": 24.0, "dolor_contenido": 12.0, "dolor_plataforma": 4.0, "dolor_modalidad": 1.0, "dolor_equipo": 16.0, "dolor_otros": 3.0, "pct_negativos": 25.71, "pct_dolor_docente": 16.7, "pct_dolor_actividades": 33.3, "pct_dolor_contenido": 16.7, "pct_dolor_plataforma": 5.6, "pct_dolor_modalidad": 1.4, "pct_dolor_equipo": 22.2, "pct_dolor_otros": 4.2, "pct_positivos": 51.4, "pct_neutros": 22.9, "color": "#f59e0b"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "PORTAFOLIOS DE INVERSIÓN", "promedio_cae": 4.308, "total_comentarios": 86, "comentarios_negativos": 33, "comentarios_positivos": 35, "comentarios_neutros": 18.0, "dolor_docente": 12.0, "dolor_actividades": 7.0, "dolor_contenido": 3.0, "dolor_plataforma": 1.0, "dolor_modalidad": 4.0, "dolor_equipo": 0, "dolor_otros": 6.0, "pct_negativos": 38.37, "pct_dolor_docente": 36.4, "pct_dolor_actividades": 21.2, "pct_dolor_contenido": 9.1, "pct_dolor_plataforma": 3.0, "pct_dolor_modalidad": 12.1, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 18.2, "pct_positivos": 40.7, "pct_neutros": 20.9, "color": "#ef4444"}, {"departamento": "918 - DEPARTAMENTO DE CIENCIAS DE LA SALUD", "materia": "PRÁCTICA PROFESIONAL I DE NUTRICIÓN Y CIENCIA DE LOS ALIMENTOS", "promedio_cae": 5.0, "total_comentarios": 10, "comentarios_negativos": 1, "comentarios_positivos": 9, "comentarios_neutros": 0, "dolor_docente": 0, "dolor_actividades": 1.0, "dolor_contenido": 0, "dolor_plataforma": 0, "dolor_modalidad": 0, "dolor_equipo": 0, "dolor_otros": 0, "pct_negativos": 10.0, "pct_dolor_docente": 0.0, "pct_dolor_actividades": 100.0, "pct_dolor_contenido": 0.0, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 0.0, "pct_positivos": 90.0, "pct_neutros": 0, "color": "#10b981"}, {"departamento": "918 - DEPARTAMENTO DE CIENCIAS DE LA SALUD", "materia": "PRÁCTICA PROFESIONAL II DE NUTRICIÓN Y CIENCIA DE LOS ALIMENTOS", "promedio_cae": 4.703333333333333, "total_comentarios": 31, "comentarios_negativos": 5, "comentarios_positivos": 21, "comentarios_neutros": 5.0, "dolor_docente": 1.0, "dolor_actividades": 3.0, "dolor_contenido": 0, "dolor_plataforma": 1.0, "dolor_modalidad": 0, "dolor_equipo": 0, "dolor_otros": 0, "pct_negativos": 16.13, "pct_dolor_docente": 20.0, "pct_dolor_actividades": 60.0, "pct_dolor_contenido": 0.0, "pct_dolor_plataforma": 20.0, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 0.0, "pct_positivos": 67.7, "pct_neutros": 16.1, "color": "#f59e0b"}, {"departamento": "1 - DEPARTAMENTO DE ARQUITECTURA Y DISEÑO", "materia": "PRÁCTICA VIVENCIAL EN TALLER ARTESANAL", "promedio_cae": 4.99, "total_comentarios": 38, "comentarios_negativos": 4, "comentarios_positivos": 33, "comentarios_neutros": 1.0, "dolor_docente": 1.0, "dolor_actividades": 2.0, "dolor_contenido": 0, "dolor_plataforma": 0, "dolor_modalidad": 0, "dolor_equipo": 0, "dolor_otros": 1.0, "pct_negativos": 10.53, "pct_dolor_docente": 25.0, "pct_dolor_actividades": 50.0, "pct_dolor_contenido": 0.0, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 25.0, "pct_positivos": 86.8, "pct_neutros": 2.6, "color": "#10b981"}, {"departamento": "918 - DEPARTAMENTO DE CIENCIAS DE LA SALUD", "materia": "PROGRAMAS DE ALIMENTACIÓN Y NUTRICIÓN", "promedio_cae": 4.06, "total_comentarios": 30, "comentarios_negativos": 11, "comentarios_positivos": 9, "comentarios_neutros": 10.0, "dolor_docente": 4.0, "dolor_actividades": 3.0, "dolor_contenido": 1.0, "dolor_plataforma": 0, "dolor_modalidad": 2.0, "dolor_equipo": 1.0, "dolor_otros": 0, "pct_negativos": 36.67, "pct_dolor_docente": 36.4, "pct_dolor_actividades": 27.3, "pct_dolor_contenido": 9.1, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 18.2, "pct_dolor_equipo": 9.1, "pct_dolor_otros": 0.0, "pct_positivos": 30.0, "pct_neutros": 33.3, "color": "#ef4444"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "PROMOCIÓN DE VENTAS", "promedio_cae": 4.45, "total_comentarios": 164, "comentarios_negativos": 40, "comentarios_positivos": 84, "comentarios_neutros": 40.0, "dolor_docente": 16.0, "dolor_actividades": 3.0, "dolor_contenido": 3.0, "dolor_plataforma": 2.0, "dolor_modalidad": 7.0, "dolor_equipo": 7.0, "dolor_otros": 2.0, "pct_negativos": 24.39, "pct_dolor_docente": 40.0, "pct_dolor_actividades": 7.5, "pct_dolor_contenido": 7.5, "pct_dolor_plataforma": 5.0, "pct_dolor_modalidad": 17.5, "pct_dolor_equipo": 17.5, "pct_dolor_otros": 5.0, "pct_positivos": 51.2, "pct_neutros": 24.4, "color": "#f59e0b"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "RESPONSABILIDAD SOCIAL CORPORATIVA", "promedio_cae": 4.5488888888888885, "total_comentarios": 466, "comentarios_negativos": 114, "comentarios_positivos": 223, "comentarios_neutros": 129.0, "dolor_docente": 29.0, "dolor_actividades": 30.0, "dolor_contenido": 17.0, "dolor_plataforma": 5.0, "dolor_modalidad": 14.0, "dolor_equipo": 14.0, "dolor_otros": 5.0, "pct_negativos": 24.46, "pct_dolor_docente": 25.4, "pct_dolor_actividades": 26.3, "pct_dolor_contenido": 14.9, "pct_dolor_plataforma": 4.4, "pct_dolor_modalidad": 12.3, "pct_dolor_equipo": 12.3, "pct_dolor_otros": 4.4, "pct_positivos": 47.9, "pct_neutros": 27.7, "color": "#f59e0b"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "SISTEMAS ORGANIZACIONALES", "promedio_cae": 4.596666666666667, "total_comentarios": 90, "comentarios_negativos": 18, "comentarios_positivos": 51, "comentarios_neutros": 21.0, "dolor_docente": 1.0, "dolor_actividades": 11.0, "dolor_contenido": 3.0, "dolor_plataforma": 0, "dolor_modalidad": 1.0, "dolor_equipo": 0, "dolor_otros": 2.0, "pct_negativos": 20.0, "pct_dolor_docente": 5.6, "pct_dolor_actividades": 61.1, "pct_dolor_contenido": 16.7, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 5.6, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 11.1, "pct_positivos": 56.7, "pct_neutros": 23.3, "color": "#f59e0b"}, {"departamento": "912 - CENTRO DE FORMACIÓN HUMANISTA", "materia": "SOCIEDAD Y CULTURA DE PAZ", "promedio_cae": 4.572222222222223, "total_comentarios": 302, "comentarios_negativos": 76, "comentarios_positivos": 146, "comentarios_neutros": 80.0, "dolor_docente": 20.0, "dolor_actividades": 33.0, "dolor_contenido": 10.0, "dolor_plataforma": 6.0, "dolor_modalidad": 2.0, "dolor_equipo": 1.0, "dolor_otros": 4.0, "pct_negativos": 25.17, "pct_dolor_docente": 26.3, "pct_dolor_actividades": 43.4, "pct_dolor_contenido": 13.2, "pct_dolor_plataforma": 7.9, "pct_dolor_modalidad": 2.6, "pct_dolor_equipo": 1.3, "pct_dolor_otros": 5.3, "pct_positivos": 48.3, "pct_neutros": 26.5, "color": "#f59e0b"}, {"departamento": "912 - CENTRO DE FORMACIÓN HUMANISTA", "materia": "SOCIEDAD Y DESARROLLO", "promedio_cae": 4.785, "total_comentarios": 274, "comentarios_negativos": 46, "comentarios_positivos": 162, "comentarios_neutros": 66.0, "dolor_docente": 11.0, "dolor_actividades": 23.0, "dolor_contenido": 6.0, "dolor_plataforma": 1.0, "dolor_modalidad": 0, "dolor_equipo": 2.0, "dolor_otros": 3.0, "pct_negativos": 16.79, "pct_dolor_docente": 23.9, "pct_dolor_actividades": 50.0, "pct_dolor_contenido": 13.0, "pct_dolor_plataforma": 2.2, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 4.3, "pct_dolor_otros": 6.5, "pct_positivos": 59.1, "pct_neutros": 24.1, "color": "#f59e0b"}, {"departamento": "905 - DEPARTAMENTO DE CIENCIAS SOCIALES Y HUMANIDADES", "materia": "SOCIOLOGÍA JURÍDICA", "promedio_cae": 4.1025, "total_comentarios": 130, "comentarios_negativos": 55, "comentarios_positivos": 42, "comentarios_neutros": 33.0, "dolor_docente": 13.0, "dolor_actividades": 14.0, "dolor_contenido": 7.0, "dolor_plataforma": 0, "dolor_modalidad": 18.0, "dolor_equipo": 1.0, "dolor_otros": 2.0, "pct_negativos": 42.31, "pct_dolor_docente": 23.6, "pct_dolor_actividades": 25.5, "pct_dolor_contenido": 12.7, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 32.7, "pct_dolor_equipo": 1.8, "pct_dolor_otros": 3.6, "pct_positivos": 32.3, "pct_neutros": 25.4, "color": "#ef4444"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "TALLER DE SÍNTESIS Y EVALUACIÓN DE CIENCIAS ECONÓMICO ADMINISTRATIVAS II", "promedio_cae": 4.4750000000000005, "total_comentarios": 564, "comentarios_negativos": 135, "comentarios_positivos": 297, "comentarios_neutros": 132.0, "dolor_docente": 48.0, "dolor_actividades": 37.0, "dolor_contenido": 10.0, "dolor_plataforma": 6.0, "dolor_modalidad": 20.0, "dolor_equipo": 7.0, "dolor_otros": 7.0, "pct_negativos": 23.94, "pct_dolor_docente": 35.6, "pct_dolor_actividades": 27.4, "pct_dolor_contenido": 7.4, "pct_dolor_plataforma": 4.4, "pct_dolor_modalidad": 14.8, "pct_dolor_equipo": 5.2, "pct_dolor_otros": 5.2, "pct_positivos": 52.7, "pct_neutros": 23.4, "color": "#f59e0b"}, {"departamento": "1 - DEPARTAMENTO DE ARQUITECTURA Y DISEÑO", "materia": "TALLER DE SÍNTESIS Y EVALUACIÓN DE DISEÑO DE PRODUCTO III", "promedio_cae": 4.875, "total_comentarios": 38, "comentarios_negativos": 6, "comentarios_positivos": 29, "comentarios_neutros": 3.0, "dolor_docente": 4.0, "dolor_actividades": 2.0, "dolor_contenido": 0, "dolor_plataforma": 0, "dolor_modalidad": 0, "dolor_equipo": 0, "dolor_otros": 0, "pct_negativos": 15.79, "pct_dolor_docente": 66.7, "pct_dolor_actividades": 33.3, "pct_dolor_contenido": 0.0, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 0.0, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 0.0, "pct_positivos": 76.3, "pct_neutros": 7.9, "color": "#f59e0b"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "TEMAS SELECTOS DE CONTADURÍA Y ESTRATEGIAS FINANCIERAS I", "promedio_cae": 4.905, "total_comentarios": 46, "comentarios_negativos": 4, "comentarios_positivos": 29, "comentarios_neutros": 13.0, "dolor_docente": 2.0, "dolor_actividades": 1.0, "dolor_contenido": 0, "dolor_plataforma": 0, "dolor_modalidad": 1.0, "dolor_equipo": 0, "dolor_otros": 0, "pct_negativos": 8.7, "pct_dolor_docente": 50.0, "pct_dolor_actividades": 25.0, "pct_dolor_contenido": 0.0, "pct_dolor_plataforma": 0.0, "pct_dolor_modalidad": 25.0, "pct_dolor_equipo": 0.0, "pct_dolor_otros": 0.0, "pct_positivos": 63.0, "pct_neutros": 28.3, "color": "#10b981"}, {"departamento": "1 - DEPARTAMENTO DE ARQUITECTURA Y DISEÑO", "materia": "TEORÍA E HISTORIA DE LA ARQUITECTURA I", "promedio_cae": 4.4775, "total_comentarios": 210, "comentarios_negativos": 86, "comentarios_positivos": 92, "comentarios_neutros": 32.0, "dolor_docente": 12.0, "dolor_actividades": 25.0, "dolor_contenido": 6.0, "dolor_plataforma": 4.0, "dolor_modalidad": 36.0, "dolor_equipo": 1.0, "dolor_otros": 2.0, "pct_negativos": 40.95, "pct_dolor_docente": 14.0, "pct_dolor_actividades": 29.1, "pct_dolor_contenido": 7.0, "pct_dolor_plataforma": 4.7, "pct_dolor_modalidad": 41.9, "pct_dolor_equipo": 1.2, "pct_dolor_otros": 2.3, "pct_positivos": 43.8, "pct_neutros": 15.2, "color": "#ef4444"}, {"departamento": "2 - DEPARTAMENTO DE CIENCIAS ECONÓMICO-ADMINISTRATIVAS", "materia": "TOMA DE DECISIONES Y SIMULACIÓN DE NEGOCIOS", "promedio_cae": 4.567142857142857, "total_comentarios": 214, "comentarios_negativos": 59, "comentarios_positivos": 98, "comentarios_neutros": 57.0, "dolor_docente": 7.0, "dolor_actividades": 10.0, "dolor_contenido": 24.0, "dolor_plataforma": 1.0, "dolor_modalidad": 14.0, "dolor_equipo": 3.0, "dolor_otros": 0, "pct_negativos": 27.57, "pct_dolor_docente": 11.9, "pct_dolor_actividades": 16.9, "pct_dolor_contenido": 40.7, "pct_dolor_plataforma": 1.7, "pct_dolor_modalidad": 23.7, "pct_dolor_equipo": 5.1, "pct_dolor_otros": 0.0, "pct_positivos": 45.8, "pct_neutros": 26.6, "color": "#f59e0b"}];

        let currentFilter = 'Todos';
        
        // Obtener departamentos únicos
        const departamentos = ['Todos', ...new Set(allData.map(d => d.departamento))].sort();

        // Crear botones de filtro
        const filterContainer = document.getElementById('filterButtons');
        departamentos.forEach(dept => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn' + (dept === 'Todos' ? ' active' : '');
            btn.textContent = dept === 'Todos' ? 'Todos' : dept;
            btn.onclick = () => filterByDepartment(dept);
            filterContainer.appendChild(btn);
        });

        // KPI Animation
        function animateValue(obj, start, end, duration, suffix = '') {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                // Ease out cubic
                const easeProgress = 1 - Math.pow(1 - progress, 3);

                let val = progress * (end - start) + start;

                // Format logic
                if (Number.isInteger(end)) {
                    obj.innerHTML = Math.floor(val).toLocaleString() + suffix;
                } else {
                    obj.innerHTML = val.toFixed(1) + suffix;
                }

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                     // Ensure final value is exact
                     if (Number.isInteger(end)) {
                        obj.innerHTML = end.toLocaleString() + suffix;
                     } else {
                        obj.innerHTML = end.toFixed(1) + suffix;
                     }
                }
            };
            window.requestAnimationFrame(step);
        }

        // Init Animations
        document.querySelectorAll('.metric-value').forEach(el => {
            const target = parseFloat(el.getAttribute('data-target'));
            const suffix = el.getAttribute('data-suffix') || '';
            animateValue(el, 0, target, 1200, suffix);
        });

        function filterByDepartment(dept) {
            currentFilter = dept;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if ((dept === 'Todos' && btn.textContent === 'Todos') ||
                    btn.textContent === dept) {
                    btn.classList.add('active');
                }
            });
            
            updatePlot();
        }

        function updatePlot() {
            const filteredData = currentFilter === 'Todos' 
                ? allData 
                : allData.filter(d => d.departamento === currentFilter);

            // Preparar datos para el scatter plot
            const x = filteredData.map(d => d.promedio_cae);
            const y = filteredData.map(d => d.comentarios_negativos);
            const sizes = filteredData.map(d => Math.sqrt(d.total_comentarios) * 2.5); // Square root scale

            // Map colors to new palette
            const colorMap = {
                '#ef4444': '#DC2626', // Critical
                '#f59e0b': '#D97706', // Warning
                '#10b981': '#059669'  // Success
            };
            
            const borderMap = {
                '#ef4444': '#B91C1C',
                '#f59e0b': '#B45309',
                '#10b981': '#047857'
            };

            const bgColors = filteredData.map(d => colorMap[d.color] || d.color);
            const borderColors = filteredData.map(d => borderMap[d.color] || '#333');

            // Crear texto del hover custom HTML styled
            const hoverText = filteredData.map(d => {
                let dolores = [];
                if (d.pct_dolor_docente > 0) dolores.push(`Docente: <b>${d.pct_dolor_docente}%</b>`);
                if (d.pct_dolor_actividades > 0) dolores.push(`Actividades: <b>${d.pct_dolor_actividades}%</b>`);
                if (d.pct_dolor_contenido > 0) dolores.push(`Contenido: <b>${d.pct_dolor_contenido}%</b>`);
                if (d.pct_dolor_plataforma > 0) dolores.push(`Plataforma: <b>${d.pct_dolor_plataforma}%</b>`);
                if (d.pct_dolor_modalidad > 0) dolores.push(`Modalidad: <b>${d.pct_dolor_modalidad}%</b>`);
                if (d.pct_dolor_equipo > 0) dolores.push(`Equipo: <b>${d.pct_dolor_equipo}%</b>`);
                if (d.pct_dolor_otros > 0) dolores.push(`Otros: <b>${d.pct_dolor_otros}%</b>`);
                
                const doloresText = dolores.length > 0 
                    ? '<div style="margin-top:8px; padding-top:8px; border-top:1px solid #eee; font-size:11px;">' + dolores.join('<br>') + '</div>'
                    : '';
                
                return `<div style="font-family: Inter, sans-serif; width: 220px;">
                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 4px; line-height: 1.2;">${d.materia}</div>
                        <div style="font-size: 11px; color: #64748B; margin-bottom: 8px;">${d.departamento}</div>
                        <div style="display:flex; justify-content:space-between; font-size:12px;">
                            <span>Promedio:</span> <b>${d.promedio_cae.toFixed(2)}</b>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:12px;">
                            <span>Negativos:</span> <b style="color:${colorMap[d.color]}">${d.comentarios_negativos} (${d.pct_negativos}%)</b>
                        </div>
                        ${doloresText}
                       </div>`;
            });

            const trace = {
                x: x,
                y: y,
                mode: 'markers',
                type: 'scatter',
                text: hoverText,
                hovertemplate: '%{text}<extra></extra>',
                marker: {
                    size: sizes,
                    sizemode: 'diameter',
                    sizemin: 6,
                    color: bgColors,
                    line: {
                        color: borderColors,
                        width: 1
                    },
                    opacity: 0.9
                }
            };

            // Calcular límites para cuadrantes
            const xRange = [3.5, 5.0]; // Fixed reasonable range for academic grades usually
            // Adjust range dynamically if data is outside
            const xMin = Math.min(...x) - 0.1;
            const xMax = Math.max(...x) + 0.1;
            if (xMin < 3.5) xRange[0] = xMin;
            if (xMax > 5.0) xRange[1] = xMax;

            const yRange = [0, Math.max(...y) * 1.1];

            // Quadrant lines
            // Assuming academic avg cut at 4.5? Or based on median?
            // The previous code used midpoint. Let's stick to midpoint visually for now or 4.5 if specified.
            // Prompt says "Data protagonist", so let's stick to simple grid.
            const xMid = (xRange[0] + xRange[1]) / 2;
            const yMid = yRange[1] / 2;

            const layout = {
                font: { family: 'Inter, sans-serif', color: '#0F172A' },
                title: false,
                xaxis: {
                    title: '<b>Promedio CAE (Desempeño Académico)</b>',
                    titlefont: { size: 12, color: '#64748B' },
                    tickfont: { color: '#64748B', size: 11 },
                    range: xRange,
                    gridcolor: 'transparent',
                    zeroline: false,
                    showline: true,
                    linecolor: '#E2E8F0'
                },
                yaxis: {
                    title: '<b>Comentarios Negativos (Volumen)</b>',
                    titlefont: { size: 12, color: '#64748B' },
                    tickfont: { color: '#64748B', size: 11 },
                    range: yRange,
                    gridcolor: 'rgba(15,23,42,0.05)',
                    gridwidth: 1,
                    griddash: 'dot',
                    zeroline: false,
                    showline: false
                },
                hovermode: 'closest',
                hoverlabel: {
                    bgcolor: '#FFFFFF',
                    bordercolor: '#E2E8F0',
                    font: { family: 'Inter, sans-serif', size: 12 },
                    align: 'left'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 60, r: 20, t: 20, b: 60 },
                height: 600,
                shapes: [
                    // Quadrant lines
                    {
                        type: 'line',
                        x0: 4.5, x1: 4.5, // Standard academic cutoff often
                        y0: yRange[0], y1: yRange[1],
                        line: { color: '#CBD5E1', width: 1, dash: 'dash' }
                    },
                    {
                        type: 'line',
                        x0: xRange[0], x1: xRange[1],
                        y0: yRange[1] * 0.3, // 30% threshold mentioned in legends roughly? Or just mid.
                        // Previous code had dynamic mid. Let's use specific threshold if possible.
                        // Legend says >30% negative is Critical.
                        // But Y axis is raw count.
                        // Let's stick to the visual midpoint from previous code or just remove arbitrary lines if they add noise.
                        // User said "Executive clarity".
                        // I will keep the lines simple.
                        line: { color: '#CBD5E1', width: 1, dash: 'dash' },
                        visible: false // Hidden by default to reduce noise unless strictly needed
                    }
                ],
                annotations: [
                    {
                        x: xRange[1], y: yRange[1],
                        text: 'Atención Prioritaria',
                        showarrow: false,
                        font: { size: 11, color: '#DC2626', weight: 600 },
                        bgcolor: 'rgba(255,255,255,0.8)',
                        xanchor: 'right', yanchor: 'top',
                        opacity: 0.7
                    },
                    {
                        x: xRange[1], y: yRange[0],
                        text: 'Desempeño Óptimo',
                        showarrow: false,
                        font: { size: 11, color: '#059669', weight: 600 },
                        bgcolor: 'rgba(255,255,255,0.8)',
                        xanchor: 'right', yanchor: 'bottom',
                        opacity: 0.7
                    }
                ]
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d', 'autoScale2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'Reporte_Inteligencia_Academica',
                    height: 1080,
                    width: 1920,
                    scale: 2
                }
            };

            Plotly.newPlot('plot', [trace], layout, config);
        }

        function exportToPNG() {
            Plotly.downloadImage('plot', {
                format: 'png',
                width: 1920,
                height: 1080,
                filename: 'Reporte_Inteligencia_Academica'
            });
        }

        // Placeholder for toggleSeries if needed or just visual
        function toggleSeries(type) {
            // Advanced interaction: could filter data by type
            console.log("Toggling " + type);
        }

        // Renderizar gráfica inicial
        updatePlot();
    </script>
</body>

</html>